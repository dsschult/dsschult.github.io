<!doctype html><html><head><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans|Source+Code+Pro:300|Tangerine:700"><link rel=stylesheet href=/static/modern-normalize.css><link rel=stylesheet href=/static/pygments.css><link rel=stylesheet href=/static/style.css><title>MongoDB: Sorting by external weights - dsschult.com</title></head><body><header><a href=/ ><img class=logo src=/static/logo.jpg></a><div class=title><h1><a href=/ >David Schultz</a></h1><h3>Just another programming blog.</h3></div><nav><a href=/ >Blog</a><a href=/about.html>About</a></nav></header><main><div class=entry><div class=entry-header><h2>MongoDB: Sorting by external weights</h2><div class=date>Date posted: March 22, 2018</div><div class=date>Last updated: July 02, 2019</div></div><div class=entry-body><p>MongoDB aggregations can be sorted by any field in a document,<br> but they can also be sorted by external factors.</p><p>Say we have some documents with tags:</p><div class=codehilite><pre><span></span><span class=p>{</span><span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=s1>&#39;tag&#39;</span><span class=p>:</span> <span class=s1>&#39;foo&#39;</span><span class=p>}</span>
<span class=p>{</span><span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=s1>&#39;b&#39;</span><span class=p>,</span> <span class=s1>&#39;tag&#39;</span><span class=p>:</span> <span class=s1>&#39;bar&#39;</span><span class=p>}</span>
<span class=p>{</span><span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=s1>&#39;c&#39;</span><span class=p>,</span> <span class=s1>&#39;tag&#39;</span><span class=p>:</span> <span class=s1>&#39;baz&#39;</span><span class=p>}</span>
<span class=p>{</span><span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=s1>&#39;d&#39;</span><span class=p>,</span> <span class=s1>&#39;tag&#39;</span><span class=p>:</span> <span class=s1>&#39;foo&#39;</span><span class=p>}</span>
<span class=p>{</span><span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=s1>&#39;e&#39;</span><span class=p>,</span> <span class=s1>&#39;tag&#39;</span><span class=p>:</span> <span class=s1>&#39;bar&#39;</span><span class=p>}</span>
<span class=p>{</span><span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=s1>&#39;f&#39;</span><span class=p>,</span> <span class=s1>&#39;tag&#39;</span><span class=p>:</span> <span class=s1>&#39;baz&#39;</span><span class=p>}</span>
<span class=p>{</span><span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=s1>&#39;g&#39;</span><span class=p>,</span> <span class=s1>&#39;tag&#39;</span><span class=p>:</span> <span class=s1>&#39;foo&#39;</span><span class=p>}</span>
</pre></div><p>We can weight these documents by tag. Let's order them<br> 'bar', 'foo', 'baz'. Any documents not tagged with those<br> three words will get ordered last. We can also limit<br> the output, asking for the first 3 documents.</p><div class=codehilite><pre><span></span><span class=n>db</span><span class=o>.</span><span class=n>collection</span><span class=o>.</span><span class=n>aggregate</span><span class=p>([</span>
   <span class=p>{</span><span class=s2>&quot;$addFields&quot;</span><span class=p>:</span> <span class=p>{</span>
       <span class=s2>&quot;weight&quot;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;$cond&quot;</span><span class=p>:</span> <span class=p>[</span>
           <span class=p>{</span><span class=s2>&quot;$eq&quot;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&quot;$tag&quot;</span><span class=p>:</span> <span class=s2>&quot;bar&quot;</span><span class=p>]</span> <span class=p>},</span>
           <span class=mi>3</span><span class=p>,</span>
           <span class=p>{</span><span class=s2>&quot;$cond&quot;</span><span class=p>:</span> <span class=p>[</span> 
               <span class=p>{</span><span class=s2>&quot;$eq&quot;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&quot;$tag&quot;</span><span class=p>:</span> <span class=s2>&quot;foo&quot;</span><span class=p>]</span> <span class=p>},</span>
               <span class=mi>2</span><span class=p>,</span>
               <span class=p>{</span><span class=s2>&quot;$cond&quot;</span><span class=p>:</span> <span class=p>[</span>
                   <span class=p>{</span><span class=s2>&quot;$eq&quot;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&quot;$tag&quot;</span><span class=p>:</span> <span class=s2>&quot;baz&quot;</span><span class=p>]</span> <span class=p>},</span>
                   <span class=mi>1</span><span class=p>,</span>
                   <span class=mi>0</span>
               <span class=p>]}</span>
           <span class=p>]}</span>
       <span class=p>]}</span>
   <span class=p>}},</span>
   <span class=p>{</span><span class=s2>&quot;$sort&quot;</span><span class=p>:</span> <span class=p>{</span> <span class=s2>&quot;weight&quot;</span><span class=p>:</span> <span class=o>-</span><span class=mi>1</span><span class=p>}</span> <span class=p>},</span>
   <span class=p>{</span><span class=s2>&quot;$limit&quot;</span><span class=p>:</span> <span class=mi>3</span><span class=p>}</span>
<span class=p>])</span>
</pre></div><p>This gives the proper sorted result:</p><div class=codehilite><pre><span></span><span class=p>{</span><span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=s1>&#39;b&#39;</span><span class=p>,</span> <span class=s1>&#39;tag&#39;</span><span class=p>:</span> <span class=s1>&#39;bar&#39;</span><span class=p>}</span>
<span class=p>{</span><span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=s1>&#39;e&#39;</span><span class=p>,</span> <span class=s1>&#39;tag&#39;</span><span class=p>:</span> <span class=s1>&#39;bar&#39;</span><span class=p>}</span>
<span class=p>{</span><span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=s1>&#39;tag&#39;</span><span class=p>:</span> <span class=s1>&#39;foo&#39;</span><span class=p>}</span>
</pre></div><p>Note that the tagged documents may be returned in<br> any order, so it's undefined which <code>bar</code> is sorted first,<br> or which <code>foo</code> is the third result.</p></div></div></main><aside class=sidebar><section><h3>Search</h3><form action=https://www.google.com/search><input type=hidden name=q value=site:dsschult.com><input id=searchbox type=text name=q value></form></section><section><h4>Other Places</h4><div> · <a href=https://github.com/dsschult>github</a> · <a href=https://www.linkedin.com/in/dsschultz/ >linkedin</a> · </div></section></aside><footer></footer></body></html>